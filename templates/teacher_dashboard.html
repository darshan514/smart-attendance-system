{% extends "base.html" %}

{% block content %}
<style>
  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
  }

  .header-section h1 {
    font-size: 32px;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
  }

  .header-section small {
    color: #718096;
    font-size: 14px;
    display: block;
    margin-top: 5px;
  }

  .header-section a {
    background: #4a5568;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
  }

  .header-section a:hover {
    background: #2d3748;
    transform: translateY(-2px);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: white;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 25px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    transition: all 0.3s;
  }

  .stat-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transform: translateY(-3px);
  }

  .stat-content {
    flex: 1;
  }

  .stat-label {
    color: #718096;
    font-size: 13px;
    margin-bottom: 10px;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
  }

  .stat-icon {
    font-size: 50px;
    opacity: 0.15;
    margin-left: 20px;
  }

  @media (max-width: 768px) {
    .header-section {
      flex-direction: column;
      gap: 20px;
      align-items: flex-start;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .stat-card {
      flex-direction: column;
    }

    .stat-icon {
      margin-left: 0;
      margin-top: 15px;
    }
  }
</style>

<div class="header-section">
  <div>
    <h1><i class="bi bi-speedometer"></i> Teacher Dashboard</h1>
    <small>Welcome back, {{ user.full_name }}!</small>
  </div>
  <a href="{{ url_for('profile') }}"><i class="bi bi-person-circle"></i> Profile</a>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-content">
      <p class="stat-label">Total Students</p>
      <h2 class="stat-value" id="total-students">{{ students_count|default(0) }}</h2>
    </div>
    <i class="bi bi-people stat-icon" style="color: #4a5568;"></i>
  </div>
  <div class="stat-card">
    <div class="stat-content">
      <p class="stat-label">Total Attendance Records</p>
      <h2 class="stat-value" id="total-attendance">{{ attendance_count|default(0) }}</h2>
    </div>
    <i class="bi bi-calendar-check stat-icon" style="color: #48bb78;"></i>
  </div>
  <div class="stat-card">
    <div class="stat-content">
      <p class="stat-label">Today's Presence</p>
      <h2 class="stat-value" id="today-present">0</h2>
          </div>
          <i class="bi bi-graph-up text-white" style="font-size: 2.5rem; opacity: 0.5;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted mb-1">Model Status</p>
            <h2 class="mb-0 text-white"><i class="bi bi-check-circle"></i> {% if trainer_exists %}Ready{% else %}Not Ready{% endif %}</h2>
          </div>
          <i class="bi bi-cpu text-white" style="font-size: 2.5rem; opacity: 0.5;"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row g-4 mb-5">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('students') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-people-fill"></i> Manage Students
          </a>
          <a href="{{ url_for('attendance') }}" class="btn btn-info btn-lg">
            <i class="bi bi-calendar-event"></i> View Attendance
          </a>
          <a href="{{ url_for('register_user') }}" class="btn btn-success btn-lg">
            <i class="bi bi-plus-circle"></i> Register Student
          </a>
          <form method="POST" action="{{ url_for('train_trigger') }}" style="display:inline;">
            <button type="submit" class="btn btn-warning btn-lg w-100">
              <i class="bi bi-gear"></i> Train Model
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> System Information</h5>
      </div>
      <div class="card-body">
        <p><strong><i class="bi bi-database"></i> Database:</strong> SQLite</p>
        <p><strong><i class="bi bi-cpu"></i> Face Recognition:</strong> OpenCV + Face Recognition</p>
        <p><strong><i class="bi bi-camera"></i> Camera Support:</strong> Enabled</p>
        <p><strong><i class="bi bi-file-earmark"></i> Export Format:</strong> CSV</p>
        <hr>
        <div class="d-grid gap-2">
          <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-download"></i> Export Attendance (CSV)
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Attendance Activity -->
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Attendance Activity</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Student ID</th>
                <th>Name</th>
                <th>Timestamp</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="recent-attendance">
              <tr class="text-center">
                <td colspan="5" class="text-muted py-4">
                  <i class="bi bi-hourglass"></i> Loading attendance records...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Students by Attendance -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-award"></i> Top Students</h5>
      </div>
      <div class="card-body">
        <div id="top-students" class="list-group list-group-flush">
          <div class="text-center text-muted py-4">
            <i class="bi bi-hourglass"></i> Loading...
          </div>
        </div>
      </div>
    </card>
  </div>
</div>

<style>
.stat-card {
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  transition: transform 0.3s, box-shadow 0.3s;
}
.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
}
.stat-card .card-body {
  padding: 1.5rem;
}
.stat-card h2 {
  font-size: 2rem;
  font-weight: bold;
}
.stat-card .text-muted {
  color: rgba(255, 255, 255, 0.8) !important;
}
.stat-card .text-white {
  color: white !important;
}
</style>

<script>
// Load statistics and recent activity on page load
document.addEventListener('DOMContentLoaded', function() {
  fetch('{{ url_for("get_statistics") }}')
    .then(response => response.json())
    .then(data => {
      // Update stats
      document.getElementById('total-students').textContent = data.total_students;
      document.getElementById('total-attendance').textContent = data.total_attendance;
      
      // Update top students
      const topStudentsDiv = document.getElementById('top-students');
      if (data.top_students && data.top_students.length > 0) {
        topStudentsDiv.innerHTML = data.top_students.map((student, index) => `
          <a href="{{ url_for('student_detail', student_id=0) }}".replace('0', student.student_id) class="list-group-item list-group-item-action">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-0">${index + 1}. ${student.name}</h6>
                <small class="text-muted">ID: ${student.student_id}</small>
              </div>
              <span class="badge bg-primary">${student.count}</span>
            </div>
          </a>
        `).join('');
      }
    })
    .catch(error => console.error('Error loading statistics:', error));

  // Load recent attendance from backend
  fetch('{{ url_for("attendance") }}')
    .then(response => response.text())
    .then(html => {
      // Parse recent records (this is simplified - in production use API endpoint)
      const recentDiv = document.getElementById('recent-attendance');
      recentDiv.innerHTML = '<tr class="text-center"><td colspan="5" class="text-muted py-4"><i class="bi bi-check-circle"></i> Attendance records loaded</td></tr>';
    });
});
</script>
{% endblock %}
